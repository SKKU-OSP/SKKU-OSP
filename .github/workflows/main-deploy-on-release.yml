name: ìƒìš© ì„œë²„ ë¦´ë¦¬ì¦ˆ ê¸°ë°˜ ìë™ ë°°í¬

on:
  release:
    types: [published]

jobs:
  deploy:
    runs-on: [self-hosted, prod-runner]

    steps:
      - name: Check runner environment
        run: |
          echo "USER: $(whoami)"
          echo "HOME: $HOME"
          echo "PWD: $(pwd)"
          echo "HOSTNAME: $(hostname)"
          echo "GITHUB_WORKSPACE: $GITHUB_WORKSPACE"
          echo "RUNNER_WORKSPACE: $RUNNER_WORKSPACE"

      - name: check git status
        run: |
          cd /home/sosd-com/SKKU-OSP || { echo "âŒ ë””ë ‰í† ë¦¬ ì—†ìŒ"; exit 1; }
          pwd && ls -al && git status

      - name: Pull released code from main branch
        run: |
          cd /home/sosd-com/SKKU-OSP && git checkout main && git pull origin main

      - name: Deploy with Docker Compose (Production)
        run: |
          cd /home/sosd-com/SKKU-OSP/deploy/prod && docker compose down && FRONTEND_VERSION=${{ github.event.release.tag_name }} BACKEND_VERSION=${{ github.event.release.tag_name }} docker compose up -d --build

      - name: Notify Slack on Success
        if: success()
        run: |
          curl -X POST https://slack.com/api/chat.postMessage \
            -H "Authorization: Bearer ${{ secrets.SLACK_BOT_TOKEN }}" \
            -H "Content-type: application/json; charset=utf-8" \
            --data '{
              "channel": "#sosd-deploy",
              "text": "âœ… [ìš´ì˜ì„œë²„ ë°°í¬ ì„±ê³µ] ë¦´ë¦¬ì¦ˆ `${{ github.event.release.tag_name }}` ë²„ì „ì´ ì„±ê³µì ìœ¼ë¡œ ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤!\nğŸ”— https://sosd.skku.edu"
            }'

      - name: Notify Slack on Failure
        if: failure()
        run: |
          curl -X POST https://slack.com/api/chat.postMessage \
            -H "Authorization: Bearer ${{ secrets.SLACK_BOT_TOKEN }}" \
            -H "Content-type: application/json; charset=utf-8" \
            --data '{
              "channel": "#sosd-deploy",
              "text": "âŒ [ìš´ì˜ì„œë²„ ë°°í¬ ì‹¤íŒ¨] ë¦´ë¦¬ì¦ˆ `${{ github.event.release.tag_name }}` ë°°í¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.\nğŸ”— https://github.com/SKKU-OSP/SKKU-OSP/actions"
            }'
